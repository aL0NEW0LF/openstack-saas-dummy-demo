#cloud-config
package_update: true
package_upgrade: true

# DNS settings
manage_etc_hosts: true
dns:
  nameservers:
    - 8.8.8.8
    - 8.8.4.4

# Install required packages
packages:
  - python3-pip
  - python3-venv
  - git

# Clone repo and setup application
runcmd:
  - pip3 install flask gunicorn
  - git clone https://github.com/aL0NEW0LF/openstack-saas-dummy-demo.git /home/ubuntu/calculator-saas

  # Setup systemd service for the calculator
  - |
    cat << 'EOL' > /etc/systemd/system/calculator.service
    [Unit]
    Description=Calculator SaaS
    After=network.target

    [Service]
    User=ubuntu
    WorkingDirectory=/home/ubuntu/calculator-saas
    ExecStart=/usr/local/bin/gunicorn -w 4 -b 0.0.0.0:5000 calculator:app
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOL

  # Start and enable the service
  - systemctl daemon-reload
  - systemctl start calculator
  - systemctl enable calculator

# Optional: Add output of the service status to the console log
final_message: "The calculator service is now up and running!"
